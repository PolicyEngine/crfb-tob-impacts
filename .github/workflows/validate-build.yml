name: Validate MyST Build

on:
  pull_request:
    paths:
      - 'jupyterbook/**'
      - '.github/workflows/validate-build.yml'
      - 'scripts/test-build.sh'

jobs:
  validate-build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'

    - name: Install uv
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH

    - name: Install dependencies
      run: |
        uv venv --python 3.13
        source .venv/bin/activate
        uv pip install -e .
        uv pip install -e .[dev]

    - name: Test MyST build
      run: |
        source .venv/bin/activate
        cd jupyterbook

        # Execute notebooks
        echo "📝 Executing notebooks..."
        for nb in *.ipynb; do
          if [ -f "$nb" ]; then
            echo "  - Executing $nb..."
            jupyter nbconvert --to notebook --execute --inplace "$nb" --ExecutePreprocessor.timeout=600
          fi
        done

        # Build the book
        echo "📚 Building MyST book..."
        myst build --html

        # Validate build output
        if [ ! -d "_build/site/public" ]; then
          echo "❌ Build failed - no output directory"
          exit 1
        fi

        # Check that HTML files were generated
        HTML_COUNT=$(find _build/site/public -name "*.html" | wc -l)
        echo "✅ Generated $HTML_COUNT HTML pages"

        if [ "$HTML_COUNT" -lt 5 ]; then
          echo "❌ Build incomplete - too few HTML files"
          exit 1
        fi

        # Check for common formatting issues
        echo "🔍 Checking for common issues..."

        # Check if any pages contain error messages
        if grep -r "Source\|Loading\.\.\." _build/site/public/*.html 2>/dev/null; then
          echo "⚠️  Warning: Some pages may have rendering issues"
        fi

        echo "✅ Build validation complete!"